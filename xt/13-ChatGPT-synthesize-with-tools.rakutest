use v6.d;
use Test;

use LLM::Functions;
use Text::SubParsers;

# This the result of llm-prompt('NothingElse')('JSON')
my $nothingElsePrompt = q:to/PROMPT_END/;
ONLY give output in the form of a JSON.
Never explain, suggest, or converse. Only return output in the specified form.
If code is requested, give only code, no explanations or accompanying text.
If a table is requested, give only a table, no other explanations or accompanying text.
Do not describe your output.
Do not explain your output.
Do not suggest anything.
Do not respond with anything other than the singularly demanded output.
Do not apologize if you are incorrect, simply try again, never apologize or add text.
Do not add anything to the output, give only the output as requested.
Your outputs can take any form as long as requested.
PROMPT_END

#| Convert chemical compound formula into molecule mass.
sub molecular-mass(
        $m, #= A molecule formula or list
                   ) { 64.058 }

my @tool-objects = LLM::Tool.new(&molecular-mass);

# Optional: If your LLM::Tool objects donâ€™t expose .Hash('Gemini'), pass @toolspecs explicitly.
# WARNING : Using this spec produces errors!
my @tool-specs = [
{
    :name("molecular-mass"),
    :description("Convert chemical compound formula into molecule mass."),
    :parameters({
        :type("object"),
        :properties( {"\$spec" => { :description("A molecule formula or list"), :type("string") }} ),
        :required(["\$spec"]),
    }),
}, ];

subtest {
    my $input = "What is the molecular mass of SO2 and O3?";

    my $final = llm-synthesize-with-tools(
            [$input, $nothingElsePrompt],
            @tool-objects,
            llm-evaluator => llm-configuration('ChatGPT', model => 'gpt-4.1-mini'),
            :8max-iterations,
            form => sub-parser('JSON'):drop):echo;

    isa-ok $final, Map:D, 'expected result type';

    is-deeply $final, { :O3(64.058), :SO2(64.058) }, 'expected result values';
}

done-testing;
